name: Auto Sync Fork & Clean Subscription

on:
  schedule:
    - cron: '0 */3 * * *'
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  sync_and_clean:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Smart Sync (Preserve Workflow)
        run: |
          # 1. 准备工作
          echo "🔄 正在检查远程上游..."
          git remote add upstream https://github.com/shaoyouvip/free.git || true
          git fetch upstream
          
          # 2. 提取上游 base64.txt 并预处理（去时间戳）
          git show upstream/main:base64.txt > base64_temp.txt
          
          if [ -s base64_temp.txt ]; then
            sed -E -i 's/[[:space:]]*# *[0-9]{4}-[0-9]{2}-[0-9]{2}([ T][0-9]{2}:[0-9]{2}:[0-9]{2})?$//g' base64_temp.txt
            sed -i 's/[[:space:]]\+$//' base64_temp.txt
          else
            echo "⚠️ 上游文件为空，跳过处理"
            exit 0
          fi

          # 3. 对比内容：如果处理后的结果和本地一样，直接结束
          if [ -f base64.txt ] && cmp -s base64.txt base64_temp.txt; then
            echo "✅ 内容一致，无需更新。"
            echo "💤 Workflow 文件保持原样，无新提交。"
            exit 0
          fi

          # =================================================
          # 4. 正式更新（关键修改！）
          # =================================================
          echo "🚀 检测到新内容！准备同步..."
          
          # 【核心魔法】
          # 从上游检出所有文件(.)，但是排除 .github 文件夹 (:!.github)
          # 这样上游的数据会覆盖本地，但你的 workflow 文件纹丝不动
          git checkout upstream/main -- . ':!.github'
          
          # 应用刚才处理好的干净 base64.txt
          mv base64_temp.txt base64.txt
          
          # 提交
          git add .
          
          # 再次检查状态，确保只有 base64.txt 被 add 了，workflow 不应该在列表里
          if git diff --cached --quiet; then
             echo "ℹ️ 奇怪，似乎没有文件变化。"
             exit 0
          fi
          
          git commit -m "Update subscription [skip ci]"
          
          # 因为我们是在当前分支上提交，不是强制重置，所以不需要 force push
          # 这样提交记录就是一条连贯的线，workflow 文件状态不会变
          git push
          echo "🎉 同步完成！Workflow 文件未受影响。"
